/**
 * STEP-NYDAY-SCAFFOLD-001
 * 目标：建立“纽约交易日权威入口”脚手架（nyDay.ts）+ 冒烟测试。
 * 约束：仅新增文件；不修改、不删除任何现有文件；零行为变更。
 *
 * 验收：
 * 1) 仅新增以下两个文件：
 *    - apps/web/app/lib/nyDay.ts
 *    - apps/web/app/lib/__tests__/nyDay.scaffold.smoke.test.ts
 * 2) 运行新增测试通过（jest 绿），且现有测试不受影响；
 * 3) 代码行为无变化（只是封装转发）。
 */

type FileAdd = { path: string; content: string };

const files: FileAdd[] = [
  {
    path: 'apps/web/app/lib/nyDay.ts',
    content: `/**
* NY Trading-Day Authority (Step 1: Scaffold Only)
* 说明：
* - 本模块作为“纽约交易日”的统一对外入口（后续所有层将逐步改为只依赖这里）。
* - 本步仅封装/转发到现有工具，不改变任何既有行为；后续步骤再慢慢迁移调用方与细节。
*/

export const NY_TZ = 'America/New_York' as const;

export type ResolveOpts = {
  /** 冻结为指定纽约交易日（YYYY-MM-DD）；若提供则优先返回该值 */
  freeze?: string;
};

// 复用现有实现（保持行为一致）
import { getLatestTradingDayStr as _latestTradingDayStr, nyDateStr as _nyDateStr } from './timezone';
import { getTradingDateStr as _calendarTradingDayStr } from './tradingDay';
import { previousTradingDay as _previousTradingDay, isTradingDay as _isTradingDay } from './marketHours';

/**
 * 统一入口（后续所有模块将逐步切换到此）：
 * - 若 opts.freeze 存在，直接返回该冻结日；
 * - 否则转发到现有 getLatestTradingDayStr（含盘前/周末等口径）。
 * 注：本步保持现有口径不变。
 */
export function resolveTradingDayStr(now: number | Date = Date.now(), opts: ResolveOpts = {}): string {
  if (opts.freeze) return opts.freeze;
  return _latestTradingDayStr(now);
}

/** 纽约本地日字符串（YYYY-MM-DD），用于展示/键名统一 */
export function ymdInNY(now: number | Date = Date.now()): string {
  return _nyDateStr(now);
}

/** 对比/兼容：现有“日历日口径”的交易日推导（后续统一收敛） */
export function calendarTradingDayStr(now: number | Date = Date.now()): string {
  return _calendarTradingDayStr(now);
}

/** 上一交易日 / 是否交易日（节假日表由现有实现提供；后续将统一纳管） */
export const previousTradingDay = _previousTradingDay;
export const isTradingDay = _isTradingDay;

// 约定：从本文件导出的函数与常量，视为“纽约交易日”的唯一对外接口（Authority）。
// 后续新增代码应仅依赖本模块，不再直接引用 timezone/tradingDay/marketHours 的内部细节。
`,
  },
  {
    path: 'apps/web/app/lib/__tests__/nyDay.scaffold.smoke.test.ts',
    content: `import { resolveTradingDayStr, ymdInNY, calendarTradingDayStr, previousTradingDay, isTradingDay, NY_TZ } from '../nyDay';
import { getLatestTradingDayStr as rawLatest } from '../timezone';

describe('nyDay (Scaffold)', () => {
  test('freeze 参数应直接透传', () => {
    expect(resolveTradingDayStr(Date.now(), { freeze: '2025-10-06' })).toBe('2025-10-06');
  });

  test('resolveTradingDayStr 行为等同现有 getLatestTradingDayStr', () => {
    // 固定时间：UTC 2025-10-06T14:30:00Z（纽约夏令时时间相当于 10:30）
    const now = new Date(Date.UTC(2025, 9, 6, 14, 30));
    expect(resolveTradingDayStr(now)).toBe(rawLatest(now));
  });

  test('辅助导出可用（存在性与格式校验）', () => {
    const now = Date.now();
    const y = ymdInNY(now);
    expect(typeof y).toBe('string');
    expect(y).toMatch(/^\\d{4}-\\d{2}-\\d{2}$/);

    const c = calendarTradingDayStr(now);
    expect(typeof c).toBe('string');
    expect(c).toMatch(/^\\d{4}-\\d{2}-\\d{2}$/);

    expect(typeof previousTradingDay).toBe('function');
    expect(typeof isTradingDay).toBe('function');
    expect(NY_TZ).toBe('America/New_York');
  });
});
`,
  },
];

// === Codex 执行器约定：apply ===
export default {
  title: 'STEP-NYDAY-SCAFFOLD-001: 新增纽约交易日权威入口（仅脚手架）',
  plan: [
    '新增 apps/web/app/lib/nyDay.ts（仅封装/转发）',
    '新增 apps/web/app/lib/__tests__/nyDay.scaffold.smoke.test.ts（冒烟测试）',
    '运行新增测试并回贴结果（不得修改其它文件）',
  ],
  changes: files.map(f => ({ type: 'add', ...f })),
  run: [
    // 按你仓库的测试脚本为准；以下为常见 jest 触发方式
    'npm test -- --runInBand apps/web/app/lib/__tests__/nyDay.scaffold.smoke.test.ts',
  ],
  acceptance: [
    '✅ 仅新增上述两个文件（git diff 无其它变更）',
    '✅ 新增测试通过（jest 绿）',
    '✅ 现有构建与测试均不受影响（零行为变更）',
  ],
  commit: 'chore(nyDay): add NY trading-day authority scaffold + smoke tests (no behavior change)',
};
